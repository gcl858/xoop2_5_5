worker_processes  1;

events {
    worker_connections  1024;
}

http {
	# 定義 upstream，包含 4 個 PHP-CGI 後端
    upstream php_backend {
        server 127.0.0.1:9001;
        server 127.0.0.1:9002;
        server 127.0.0.1:9003;
        server 127.0.0.1:9004;
        
        # 可選：設定負載均衡策略
        # least_conn;  # 最少連接數
        # ip_hash;     # IP 雜湊
		# 負載均衡策略 - 高併發建議使用 least_conn
        least_conn;
        
        # 啟用長連接以提升效能
        keepalive 32;
        keepalive_timeout 60s;
        keepalive_requests 100;
    }
	
    include       mime.types;
    default_type  application/octet-stream;
	
	# 自訂日誌格式 - 包含負載均衡和 PHP 執行資訊
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'upstream: $upstream_addr '
                       'upstream_status: $upstream_status '
                       'upstream_response_time: $upstream_response_time '
                       'request_time: $request_time '
                       'script: "$document_root$fastcgi_script_name" '
                       'fastcgi_script: "$fastcgi_script_name"';
    
    # PHP 專用詳細日誌格式
    log_format php_detail '$time_local | '
                         'Client: $remote_addr | '
                         'Request: "$request" | '
                         'Status: $status | '
                         'Backend: $upstream_addr | '
                         'Backend_Status: $upstream_status | '
                         'Response_Time: ${upstream_response_time}s | '
                         'Total_Time: ${request_time}s | '
                         'Script_File: "$document_root$fastcgi_script_name" | '
                         'Query: "$query_string" | '
                         'Method: $request_method';
    
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;
        
        root   D:/wamp/www;  # PHP 網頁根目錄
        index  index.php index.html;

		# 使用自訂的詳細日誌格式
        access_log  logs/access.log detailed;
        access_log  logs/php_access.log php_detail;
        error_log   logs/error.log debug;
		
        location / {
            try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
			# 記錄 PHP 請求的額外資訊
            access_log  logs/php_detail.log php_detail;
			
            #fastcgi_pass   127.0.0.1:9000;
			fastcgi_pass   php_backend;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
			
			# FastCGI 超時設定
            fastcgi_connect_timeout 60s;
            fastcgi_send_timeout 60s;
            fastcgi_read_timeout 60s;
        }
    }
}