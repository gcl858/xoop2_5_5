# PHP-CGI 監控和自動重啟腳本
# 請以系統管理員身份執行

$PHP_PATH = "D:\nPHP\php8"
$PHP_INI = "D:\nPHP\php.ini"
$PORTS = @(9001, 9002, 9003, 9004)
$LOG_FILE = "D:\nPHP\monitor.log"

function Write-Log {
    param($Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] $Message"
    Write-Host $logMessage
    Add-Content -Path $LOG_FILE -Value $logMessage
}

function Test-PortListening {
    param([int]$Port)
    try {
        $connection = Get-NetTCPConnection -LocalPort $Port -State Listen -ErrorAction SilentlyContinue
        return $connection -ne $null
    } catch {
        return $false
    }
}

function Start-PHPCGIProcess {
    param([int]$Port)
    
    $arguments = "-b 127.0.0.1:$Port -c `"$PHP_INI`""
    
    $processInfo = New-Object System.Diagnostics.ProcessStartInfo
    $processInfo.FileName = "$PHP_PATH\php-cgi.exe"
    $processInfo.Arguments = $arguments
    $processInfo.WorkingDirectory = $PHP_PATH
    $processInfo.UseShellExecute = $false
    $processInfo.CreateNoWindow = $true
    
    try {
        $process = [System.Diagnostics.Process]::Start($processInfo)
        Write-Log "Started PHP-CGI on port $Port (PID: $($process.Id))"
        Start-Sleep -Seconds 2  # 等待進程啟動
        return $true
    } catch {
        Write-Log "Failed to start PHP-CGI on port ${Port}: $_"
        return $false
    }
}

function Stop-PHPCGIByPort {
    param([int]$Port)
    
    $connection = Get-NetTCPConnection -LocalPort $Port -State Listen -ErrorAction SilentlyContinue
    if ($connection) {
        $pid = $connection.OwningProcess
        try {
            Stop-Process -Id $pid -Force
            Write-Log "Stopped orphaned process on port $Port (PID: $pid)"
            Start-Sleep -Seconds 1
        } catch {
            Write-Log "Failed to stop process on port ${Port}: $_"
        }
    }
}

Write-Log "=== PHP-CGI Monitor Started ==="

# 主監控循環
while ($true) {
    foreach ($port in $PORTS) {
        $isListening = Test-PortListening -Port $port
        
        if (-not $isListening) {
            Write-Log "Port $port is not listening. Attempting to restart..."
            
            # 確保舊進程已停止
            Stop-PHPCGIByPort -Port $port
            
            # 啟動新進程
            $started = Start-PHPCGIProcess -Port $port
            
            if ($started) {
                # 驗證啟動成功
                Start-Sleep -Seconds 2
                if (Test-PortListening -Port $port) {
                    Write-Log "Successfully restarted PHP-CGI on port $port"
                } else {
                    Write-Log "WARNING: Port $port still not listening after restart attempt"
                }
            }
        }
    }
    
    # 每30秒檢查一次
    Start-Sleep -Seconds 30
}
