[PHP]
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; PHP 8.4 高併發、高效能配置 (Windows Server 2022)
; 適用於 OpenResty + PHP-CGI 負載均衡架構
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;
; 核心效能設定
;;;;;;;;;;;;;;;;;;;

; 關閉不必要的功能以提升效能
expose_php = Off
short_open_tag = Off

; 記憶體限制 - 根據伺服器記憶體調整
; 12 核心，建議每個 PHP-CGI 配置 256M-512M
memory_limit = 512M

; 執行時間限制
max_execution_time = 60
max_input_time = 60

; POST 資料大小限制
post_max_size = 32M
upload_max_filesize = 32M
max_file_uploads = 20

; 輸入變數限制 - 防止 Hash DoS 攻擊
max_input_vars = 3000
max_input_nesting_level = 64

;;;;;;;;;;;;;;;;;;;
; 錯誤處理 (生產環境)
;;;;;;;;;;;;;;;;;;;

; 生產環境應關閉錯誤顯示
display_errors = Off
display_startup_errors = Off

; 記錄錯誤到檔案
log_errors = On
error_log = "D:\nPHP\php8\logs\php_error.log"
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

; 忽略重複錯誤以減少 I/O
ignore_repeated_errors = On
ignore_repeated_source = On

;;;;;;;;;;;;;;;;;;;
; 輸出緩衝
;;;;;;;;;;;;;;;;;;;

; 啟用輸出緩衝以提升效能
output_buffering = 4096
implicit_flush = Off

; 不使用 output_handler，由應用程式控制
output_handler =

;;;;;;;;;;;;;;;;;;;
; Realpath Cache - 重要效能提升
;;;;;;;;;;;;;;;;;;;

; 增加 realpath cache 以減少文件系統查詢
realpath_cache_size = 80M
realpath_cache_ttl = 3000

;;;;;;;;;;;;;;;;;;;
; OPcache 配置 (需要啟用擴充)
;;;;;;;;;;;;;;;;;;;

[opcache]
; 啟用 OPcache (生產環境必備)
opcache.enable = 1
opcache.enable_cli = 0

; 記憶體配置
opcache.memory_consumption = 256
opcache.interned_strings_buffer = 16
opcache.max_accelerated_files = 10000

; 驗證策略
opcache.revalidate_freq = 60
opcache.validate_timestamps = 1
opcache.fast_shutdown = 1

; 檔案快取
opcache.file_cache = "D:\nPHP\php8\opcache"
opcache.file_cache_only = 0

; 優化選項
opcache.enable_file_override = 1
opcache.optimization_level = 0x7FFEBFFF
opcache.huge_code_pages = 0

; JIT (Just-In-Time) 編譯 - PHP 8.x 新功能
opcache.jit = tracing
opcache.jit_buffer_size = 128M

;;;;;;;;;;;;;;;;;;;
; Session 設定
;;;;;;;;;;;;;;;;;;;

[Session]
session.save_handler = files
session.save_path = "D:\nPHP\php8\sessions"

; Session 效能優化
session.use_strict_mode = 1
session.use_cookies = 1
session.use_only_cookies = 1
session.cookie_httponly = 1
session.cookie_samesite = Lax

; 降低 GC 頻率以提升效能
session.gc_probability = 1
session.gc_divisor = 1000
session.gc_maxlifetime = 1440

; 啟用延遲寫入
session.lazy_write = 1

;;;;;;;;;;;;;;;;;;;
; FastCGI 專用設定
;;;;;;;;;;;;;;;;;;;

[fastcgi]
fastcgi.impersonate = 0
fastcgi.logging = 1

[cgi]
cgi.fix_pathinfo = 1
cgi.force_redirect = 0
cgi.rfc2616_headers = 0

;;;;;;;;;;;;;;;;;;;
; 安全設定
;;;;;;;;;;;;;;;;;;;

; 停用危險函數
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; 限制檔案存取
open_basedir = "D:\wamp\www;D:\nPHP\php8\sessions;C:\Windows\Temp"

; 關閉遠端檔案存取 (如不需要)
allow_url_fopen = On
allow_url_include = Off

;;;;;;;;;;;;;;;;;;;
; 擴充模組載入
;;;;;;;;;;;;;;;;;;;

extension_dir = "D:\nPHP\php8\ext"

; === Zend 擴充 (必須使用 zend_extension) ===
; OPcache 是 Zend Extension，必須用 zend_extension 載入
zend_extension=opcache

; 常用擴充 (根據需求調整)
extension=curl
extension=fileinfo
extension=gd
extension=mbstring
extension=mysqli
extension=pdo_mysql
extension=openssl


; 選用擴充
;extension=redis
;extension=memcache
;extension=apcu

;;;;;;;;;;;;;;;;;;;
; 資料庫連線池優化
;;;;;;;;;;;;;;;;;;;

[MySQLi]
mysqli.max_persistent = -1
mysqli.allow_persistent = On
mysqli.max_links = -1
mysqli.default_port = 3306
mysqli.reconnect = Off

[MySQL]
; 舊式 MySQL 擴充設定 (已棄用，但保留相容性)
mysql.allow_persistent = On
mysql.max_persistent = 10
mysql.max_links = 20

[PDO_MySQL]
; PDO MySQL 驅動設定
pdo_mysql.default_socket = 

[MySQLnd]
; MySQL Native Driver 設定
; 連線快取大小
mysqlnd.net_cmd_buffer_size = 4096
mysqlnd.net_read_buffer_size = 32768

; 統計資訊收集 (生產環境可關閉以提升效能)
mysqlnd.collect_statistics = Off
mysqlnd.collect_memory_statistics = Off

;;;;;;;;;;;;;;;;;;;
; 其他優化設定
;;;;;;;;;;;;;;;;;;;

; 時區設定
[Date]
date.timezone = "Asia/Taipei"

; 預設字元集
default_charset = "UTF-8"

; 關閉 magic quotes (PHP 5.4+ 已移除)
; 此處僅作記錄

; 關閉自動新增斜線
variables_order = "EGPCS"

; Zend 引擎優化
[Zend]
zend.enable_gc = 1
zend.exception_ignore_args = 0